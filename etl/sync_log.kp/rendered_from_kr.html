<!DOCTYPE html>
<html>

    <head>
        <meta charset="utf-8">

        <title> Knowledge </title>

        <!-- js includes at the top as post embedded js colliding -->
        <script src="/static/modules/jquery/jquery.min.js"></script>
        <script src="/static/modules/tether/js/tether.min.js"></script>
        <script src="/static/modules/bootstrap/js/bootstrap.min.js"></script>
        <script src="/static/modules/bootstrap-slider/js/bootstrap-slider.min.js"></script>
        <script src="/static/modules/typeahead.js/typeahead.bundle.min.js"></script>
        <script src="/static/modules/handlebars/js/handlebars.js"></script>
        <script src="/static/js/helpers.js"></script>
        <script src="/static/modules/select2/js/select2.min.js"></script>
        <script src="/static/modules/hightlight.pack.js/highlight.pack.js"></script>
        <script src="/static/modules/marked.js/marked.js"></script>

        <!-- require js is used for plotly, but has a bunch of collisions with other js packages
             make sure to have it be last js package imported -->
        <script src="/static/modules/require.js/require.min.js"></script>

        <!--[if lt IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/2.1.0/es5-shim.min.js"></script>
        <![endif]-->
        <link rel="stylesheet" href="/static/modules/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="/static/modules/bootstrap-slider/css/bootstrap-slider.min.css">
        <link rel="stylesheet" type='text/css' href="/static/css/custom.css">
        <link rel="stylesheet" type='text/css' href="/static/modules/select2/css/select2.min.css">
        <link href='https://fonts.googleapis.com/css?family=Lato:400,900|Playfair+Display|Source+Serif+Pro:400,700' rel='stylesheet' type='text/css'>
        <link rel="shortcut icon" href="/static/images/favicon.png">

        
<link rel="stylesheet" href="/static/css/codehilite-friendly.css">

        <style>
            .spinner {
                position: fixed;
                top: 50%;
                left: 50%;
                margin-left: -50px; /* half width of the spinner gif */
                margin-top: -50px; /* half height of the spinner gif */
                text-align:center;
                z-index:1234;
                overflow: auto;
                width: 100px; /* width of the spinner gif */
                height: 102px; /*hight of the spinner gif +2px to fix IE8 issue */
            }

            .table {
              font-size: 14px;
            }

            .modal-content {
              max-width: 1024px;
            }

             

          </style>


    </head>


    <body>

        <div class="navbar navbar-knowledge" role="navigation">
            <div class="container page-container">
                <a  href="/" aria-selected="false" class="logo-image navbar-text" style='margin-top:16px; margin-left: -7px'>
                    <img width="125" src='/static/images/logo-white.svg'></img>
                </a>
                <a id="feed_tab" href="/" aria-selected="false" class="navbar-text" style='margin-top:18px'>
                    Home
                </a>
                <a id="favorites_tab" href="/favorites" aria-selected="false" class="navbar-text" style='margin-top:18px'>
                    Favorites
                </a>
                <a id="help_tab" href="/about" aria-selected="false" class="navbar-text" style='margin-top:18px'>
                    About
                </a>
                <a id="stats_tab" href="/stats" aria-selected="false" class="navbar-text" style='margin-top:18px'>
                    Stats
                </a>
                <a id="webposts_tab" href="/create"
                   class="btn btn-primary navbar-text pull-right"
                   style='border-radius:4px; margin-top:10px; margin-right:-10px; background-color: #00a699; color:white; border-color: #00a699'>
                    Write a Post!
                </a>
                <div class="pull-right">
                    <div class="form-group">
                        <input class="form-control" id="searchbar" placeholder="Search for Knowledge" style="text-align:right">
                    </div>
                </div>
            </div>
        </div>

        <div class="container page-container">

            

    

    <br>
    <div class="container-fluid">
      <div class="row">
        <div class="col-md-6">
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-default btn-rendered">
              View Post
            </button>
            <button type="button" class="btn btn-default btn-raw">
              View Raw Markdown
            </button>
            
          </div>
        </div>
        <div class="col-md-2">
        </div>
        <div class="col-md-4 text-right">
          
            <i class="glyphicon glyphicon-eye-open" id="pageview_stats" style='color: #9CA299'></i>
            <div id="pageview_stats" style="display: inline-block">
              Viewed 1 times by 1 different users
            </div>
          
          
            <i class="glyphicon glyphicon-heart-empty glyphicon-clickable pop" style="font-size:16pt" id="tooltip-like" data-placement="bottom"
             data-trigger="#tooltip-like"
             data-container="body"
             data-toggle="popover"
             data-content='<div>Like This Post</div>'></i>
          
          
        </div>
      </div>
      <div class="row col-md-12">
        
        
      </div>
    </div>


    <div class='container-fluid'>
        <div class="row">
            <div class="col-md-12">
                <div id="renderedMarkdown">
                    
    <div class='metadata'>
    <h1>Bug 1291340 - Import sync log data</h1>
    <span class='authors'><a href='/feed?authors=mreid-moz'>mreid-moz</a></span>
    <span class='date_created'>November 15, 2016</span>
    <span class='date_updated'>(Last Updated: July 10, 2017)</span>
    <span class='tldr'><p>Read, convert, and store sync log data to Parquet form per <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1291340">bug 1291340</a>.</p></span>
    <span class='tags'></span>
    </div>
    <h2 id="bug-1291340-import-sync-log-data">Bug 1291340 - Import sync log data</h2>
<p>Read, convert, and store sync log data to Parquet form per <a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1291340">bug 1291340</a>.</p>
<p>Conversion code is ported from the <a href="https://github.com/dannycoates/smt">smt repo</a>.</p>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span> <span class="k">as</span> <span class="n">dt</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">from</span> <span class="nn">moztelemetry.dataset</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">environ</span>

<span class="c1"># Determine run parameters</span>
<span class="n">source_bucket</span> <span class="o">=</span> <span class="s1">&#39;net-mozaws-prod-us-west-2-pipeline-analysis&#39;</span>
<span class="n">dest_bucket</span> <span class="o">=</span> <span class="n">source_bucket</span>
<span class="n">dest_s3_prefix</span> <span class="o">=</span> <span class="s2">&quot;s3://{}/mreid&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_bucket</span><span class="p">)</span>

<span class="k">if</span> <span class="s2">&quot;bucket&quot;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="n">dest_bucket</span> <span class="o">=</span> <span class="n">environ</span><span class="p">[</span><span class="s2">&quot;bucket&quot;</span><span class="p">]</span>
    <span class="n">dest_s3_prefix</span> <span class="o">=</span> <span class="s2">&quot;s3://{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_bucket</span><span class="p">)</span>

<span class="n">yesterday</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">dt</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># Default to running for &quot;yesterday&quot; unless we&#39;ve been given a</span>
<span class="c1"># specific date via the environment.</span>
<span class="n">target_day</span> <span class="o">=</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">yesterday</span><span class="p">)</span>
<span class="k">print</span> <span class="s2">&quot;Running import for {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_day</span><span class="p">)</span>
</pre></div>


<h3 id="read-the-source-log-data">Read the source log data</h3>
<p>The sync data on S3 is stored in framed heka format, and is read using the <code>Dataset</code> API.</p>
<div class="codehilite"><pre><span></span><span class="c1"># Read the source data</span>
<span class="n">schema</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">target_prefix</span> <span class="o">=</span> <span class="s1">&#39;sync-metrics/data&#39;</span>
<span class="n">sync</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">source_bucket</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">target_prefix</span><span class="p">)</span>

<span class="c1"># The sync data on S3 does not have a proper &quot;date&quot; dimension, but the date is encoded </span>
<span class="c1"># in the key names themselves.</span>
<span class="c1"># Fetch the summaries and filter the list to the target day.</span>
<span class="n">summary_prefix</span> <span class="o">=</span> <span class="s2">&quot;{}/{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_prefix</span><span class="p">,</span> <span class="n">target_day</span><span class="p">)</span>
<span class="n">sync_summaries</span> <span class="o">=</span> <span class="p">[</span> <span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">sync</span><span class="o">.</span><span class="n">summaries</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="k">if</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">summary_prefix</span><span class="p">)</span> <span class="p">]</span>
</pre></div>


<h3 id="custom-heka-decoder">Custom heka decoder</h3>
<p>The standard heka decoder assumes (based on Telemetry data) that all fields whose names have a <code>.</code> in them contain nested json strings. This is not true for sync log messages, which have fields such as <code>syncstorage.storage.sql.db.execute</code> with simple scalar values.</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">from</span> <span class="nn">moztelemetry.heka.message_parser</span> <span class="kn">import</span> <span class="n">unpack</span>

<span class="c1"># Custom decoder for sync messages since we can have scalar fields with dots in their names.</span>
<span class="k">def</span> <span class="nf">sync_decoder</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">record</span><span class="p">,</span> <span class="n">total_bytes</span> <span class="ow">in</span> <span class="n">unpack</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">result</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;Timestamp&quot;</span><span class="p">:</span> <span class="n">record</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">timestamp</span><span class="p">,</span>
                <span class="s2">&quot;Type&quot;</span><span class="p">:</span>      <span class="n">record</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="s2">&quot;Hostname&quot;</span><span class="p">:</span>  <span class="n">record</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">hostname</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">record</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">value_string</span>
                <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">value_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># TODO: handle bytes in a way that doesn&#39;t cause problems with JSON</span>
                    <span class="c1"># value = field.value_bytes</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">value_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">value_integer</span>
                <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">value_type</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">value_double</span>
                <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">value_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">value_bool</span>

                <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

            <span class="k">yield</span> <span class="n">result</span>

    <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">:</span>
        <span class="k">pass</span>  <span class="c1"># https://github.com/boto/boto/issues/2830</span>

<span class="n">sync_records</span> <span class="o">=</span> <span class="n">sync</span><span class="o">.</span><span class="n">records</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">decode</span><span class="o">=</span><span class="n">sync_decoder</span><span class="p">,</span> <span class="n">summaries</span><span class="o">=</span><span class="n">sync_summaries</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1"># What do the records look like?</span>

<span class="c1"># Example heka message:</span>
<span class="c1">#Timestamp: 2016-10-28 15:11:45.98653696 -0300 ADT</span>
<span class="c1">#Type: mozsvc.metrics</span>
<span class="c1">#Hostname: ip-172-31-39-11</span>
<span class="c1">#Pid: 11383</span>
<span class="c1">#UUID: 155866c8-cc58-4048-a58c-6226c620fc57</span>
<span class="c1">#Logger: Sync-1_5</span>
<span class="c1">#Payload:</span>
<span class="c1">#EnvVersion: 1</span>
<span class="c1">#Severity: 7</span>
<span class="c1">#Fields: [name:&quot;remoteAddressChain&quot; representation:&quot;&quot; value_string:&quot;&quot; value_string:&quot;&quot;  </span>
<span class="c1">#         name:&quot;path&quot; value_string:&quot;https://host/ver/somenum/storage/tabs&quot;  </span>
<span class="c1">#         name:&quot;fxa_uid&quot; value_string:&quot;some_id&quot;  </span>
<span class="c1">#         name:&quot;user_agent_version&quot; value_type:DOUBLE value_double:49  </span>
<span class="c1">#         name:&quot;user_agent_os&quot; value_string:&quot;Windows 7&quot;  </span>
<span class="c1">#         name:&quot;device_id&quot; value_string:&quot;some_device_id&quot;  </span>
<span class="c1">#         name:&quot;method&quot; value_string:&quot;POST&quot;  </span>
<span class="c1">#         name:&quot;user_agent_browser&quot; value_string:&quot;Firefox&quot;  </span>
<span class="c1">#         name:&quot;name&quot; value_string:&quot;mozsvc.metrics&quot;  </span>
<span class="c1">#         name:&quot;request_time&quot; value_type:DOUBLE value_double:0.003030061721801758  </span>
<span class="c1">#         name:&quot;code&quot; value_type:DOUBLE value_double:200 </span>
<span class="c1">#        ]</span>

<span class="c1"># Example record:</span>
<span class="c1">#sync_records.first()</span>

<span class="c1"># {u&#39;code&#39;: 200.0,</span>
<span class="c1">#  u&#39;device_id&#39;: u&#39;some_device_id&#39;,</span>
<span class="c1">#  u&#39;fxa_uid&#39;: u&#39;some_id&#39;,</span>
<span class="c1">#  &#39;meta&#39;: {&#39;Hostname&#39;: u&#39;ip-172-31-39-11&#39;,</span>
<span class="c1">#   &#39;Timestamp&#39;: 1477678305976742912L,</span>
<span class="c1">#   &#39;Type&#39;: u&#39;mozsvc.metrics&#39;},</span>
<span class="c1">#  u&#39;method&#39;: u&#39;GET&#39;,</span>
<span class="c1">#  u&#39;name&#39;: u&#39;mozsvc.metrics&#39;,</span>
<span class="c1">#  u&#39;path&#39;: u&#39;https://host/ver/somenum/storage/crypto/keys&#39;,</span>
<span class="c1">#  u&#39;remoteAddressChain&#39;: u&#39;&#39;,</span>
<span class="c1">#  u&#39;request_time&#39;: 0.017612934112548828,</span>
<span class="c1">#  u&#39;syncstorage.storage.sql.db.execute&#39;: 0.014925241470336914,</span>
<span class="c1">#  u&#39;syncstorage.storage.sql.pool.get&#39;: 5.221366882324219e-05,</span>
<span class="c1">#  u&#39;user_agent_browser&#39;: u&#39;Firefox&#39;,</span>
<span class="c1">#  u&#39;user_agent_os&#39;: u&#39;Windows 7&#39;,</span>
<span class="c1">#  u&#39;user_agent_version&#39;: 49.0}</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1"># Convert data. Code ported from https://github.com/dannycoates/smt</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">Row</span>

<span class="k">def</span> <span class="nf">sha_prefix</span><span class="p">(</span><span class="n">v</span><span class="p">):</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha256</span><span class="p">()</span>
    <span class="n">h</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[</span><span class="mi">0</span><span class="p">:</span><span class="mi">32</span><span class="p">]</span>

<span class="n">path_uid</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;(\d+)\/storage\/&quot;</span><span class="p">)</span>
<span class="n">path_bucket</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s2">&quot;\d+\/storage\/(\w+)&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">getUid</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">path_uid</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sha_prefix</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">None</span>

<span class="k">def</span> <span class="nf">deriveDeviceId</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">agent</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">uid</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="k">return</span> <span class="n">sha_prefix</span><span class="p">(</span><span class="s2">&quot;{}{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">agent</span><span class="p">))</span>

<span class="n">SyncRow</span> <span class="o">=</span> <span class="n">Row</span><span class="p">(</span><span class="s2">&quot;uid&quot;</span><span class="p">,</span> <span class="s2">&quot;s_uid&quot;</span><span class="p">,</span> <span class="s2">&quot;dev&quot;</span><span class="p">,</span> <span class="s2">&quot;s_dev&quot;</span><span class="p">,</span> <span class="s2">&quot;ts&quot;</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="p">,</span> <span class="s2">&quot;code&quot;</span><span class="p">,</span> 
              <span class="s2">&quot;bucket&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="s2">&quot;ua_browser&quot;</span><span class="p">,</span> <span class="s2">&quot;ua_version&quot;</span><span class="p">,</span> <span class="s2">&quot;ua_os&quot;</span><span class="p">,</span> <span class="s2">&quot;host&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">convert</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
    <span class="n">bmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">path_bucket</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">bmatch</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">None</span>
    <span class="n">bucket</span> <span class="o">=</span> <span class="n">bmatch</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">uid</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fxa_uid&quot;</span><span class="p">)</span>
    <span class="n">synth_uid</span> <span class="o">=</span> <span class="n">getUid</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">))</span>
    <span class="n">dev</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;device_id&quot;</span><span class="p">)</span>
    <span class="n">synth_dev</span> <span class="o">=</span> <span class="n">deriveDeviceId</span><span class="p">(</span><span class="n">synth_uid</span><span class="p">,</span>
        <span class="s2">&quot;{}{}{}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_agent_browser&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_agent_version&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_agent_os&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
      <span class="p">)</span>

    <span class="n">code</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="c1"># support modern mozlog&#39;s use of errno for http status</span>
    <span class="n">errno</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;errno&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">errno</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">errno</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># success</span>
            <span class="n">code</span> <span class="o">=</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">errno</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">code</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">code</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;request_time&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">converted</span> <span class="o">=</span> <span class="n">SyncRow</span><span class="p">(</span>
        <span class="p">(</span><span class="n">uid</span> <span class="ow">or</span> <span class="n">synth_uid</span><span class="p">),</span>
        <span class="n">synth_uid</span><span class="p">,</span>
        <span class="p">(</span><span class="n">dev</span> <span class="ow">or</span> <span class="n">synth_dev</span><span class="p">),</span>
        <span class="n">synth_dev</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Timestamp&quot;</span><span class="p">),</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;method&quot;</span><span class="p">),</span>
        <span class="n">code</span><span class="p">,</span>
        <span class="n">bucket</span><span class="p">,</span>
        <span class="n">t</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_agent_browser&quot;</span><span class="p">),</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_agent_version&quot;</span><span class="p">),</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;user_agent_os&quot;</span><span class="p">),</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;meta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Hostname&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">converted</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">converted</span> <span class="o">=</span> <span class="n">sync_records</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">convert</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">converted</span> <span class="o">=</span> <span class="n">converted</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SQLContext</span>
<span class="n">sync_df</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">(</span><span class="n">converted</span><span class="p">)</span>
<span class="n">sync_df</span><span class="o">.</span><span class="n">printSchema</span><span class="p">()</span>
</pre></div>


<div class="codehilite"><pre><span></span>root
 |-- uid: string (nullable = true)
 |-- s_uid: string (nullable = true)
 |-- dev: string (nullable = true)
 |-- s_dev: string (nullable = true)
 |-- ts: long (nullable = true)
 |-- method: string (nullable = true)
 |-- code: long (nullable = true)
 |-- bucket: string (nullable = true)
 |-- t: double (nullable = true)
 |-- ua_browser: string (nullable = true)
 |-- ua_version: double (nullable = true)
 |-- ua_os: string (nullable = true)
 |-- host: string (nullable = true)
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1"># Determine if we need to repartition.</span>
<span class="c1"># A record is something like 112 bytes, so figure out how many partitions</span>
<span class="c1"># we need to end up with reasonably-sized files.</span>
<span class="n">records_per_partition</span> <span class="o">=</span> <span class="mi">2500000</span>
<span class="n">total_records</span> <span class="o">=</span> <span class="n">sync_df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<span class="k">print</span> <span class="s2">&quot;Found {} sync records&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">total_records</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="n">num_partitions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">total_records</span><span class="p">)</span> <span class="o">/</span> <span class="n">records_per_partition</span><span class="p">))</span>

<span class="k">if</span> <span class="n">num_partitions</span> <span class="o">!=</span> <span class="n">sync_df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">getNumPartitions</span><span class="p">():</span>
    <span class="k">print</span> <span class="s2">&quot;Repartitioning with {} partitions&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">num_partitions</span><span class="p">)</span>
    <span class="n">sync_df</span> <span class="o">=</span> <span class="n">sync_df</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="n">num_partitions</span><span class="p">)</span>

<span class="c1"># Store data</span>
<span class="n">sync_log_s3path</span> <span class="o">=</span> <span class="s2">&quot;{}/sync_log/v1/day={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_s3_prefix</span><span class="p">,</span> <span class="n">target_day</span><span class="p">)</span>
<span class="n">sync_df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">sync_log_s3path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1"># Transform, compute and store rollups</span>
<span class="n">sync_df</span><span class="o">.</span><span class="n">registerTempTable</span><span class="p">(</span><span class="s2">&quot;sync&quot;</span><span class="p">)</span>
<span class="n">sql_transform</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  select</span>
<span class="s1">    uid,</span>
<span class="s1">    dev,</span>
<span class="s1">    ts,</span>
<span class="s1">    t,</span>
<span class="s1">    case </span>
<span class="s1">     when substring(ua_os,0,7) in (&#39;iPad&#39;, &#39;iPod&#39;, &#39;iPhone&#39;) then &#39;ios&#39;</span>
<span class="s1">     when substring(ua_os,0,7) = &#39;Android&#39; then &#39;android&#39;</span>
<span class="s1">     when substring(ua_os,0,7) = &#39;Windows&#39; then &#39;windows&#39;</span>
<span class="s1">     when substring(ua_os,0,7) = &#39;Macinto&#39; then &#39;mac&#39;</span>
<span class="s1">     when substring(ua_os,0,7) = &#39;Linux&#39; then &#39;linux&#39;</span>
<span class="s1">     when ua_os is null then &#39;unknown&#39;</span>
<span class="s1">     else &#39;other&#39;</span>
<span class="s1">    end as ua_os,</span>
<span class="s1">    ua_browser,</span>
<span class="s1">    ua_version,</span>
<span class="s1">    case method when &#39;POST&#39; then 1 end as posts,</span>
<span class="s1">    case method when &#39;GET&#39; then 1 end as gets,</span>
<span class="s1">    case method when &#39;PUT&#39; then 1 end as puts,</span>
<span class="s1">    case method when &#39;DELETE&#39; then 1 end as dels,</span>
<span class="s1">    case when code &lt; 300 then 1 end as aoks,</span>
<span class="s1">    case when code &gt; 399 and code &lt; 500 then 1 end as oops,</span>
<span class="s1">    case when code &gt; 499 and code &lt; 999 then 1 end as fups,</span>
<span class="s1">    case when bucket = &#39;clients&#39; and method = &#39;GET&#39; then 1 end as r_clients,</span>
<span class="s1">    case when bucket = &#39;crypto&#39; and method = &#39;GET&#39; then 1 end as r_crypto,</span>
<span class="s1">    case when bucket = &#39;forms&#39; and method = &#39;GET&#39; then 1 end as r_forms,</span>
<span class="s1">    case when bucket = &#39;history&#39; and method = &#39;GET&#39; then 1 end as r_history,</span>
<span class="s1">    case when bucket = &#39;keys&#39; and method = &#39;GET&#39; then 1 end as r_keys,</span>
<span class="s1">    case when bucket = &#39;meta&#39; and method = &#39;GET&#39; then 1 end as r_meta,</span>
<span class="s1">    case when bucket = &#39;bookmarks&#39; and method = &#39;GET&#39; then 1 end as r_bookmarks,</span>
<span class="s1">    case when bucket = &#39;prefs&#39; and method = &#39;GET&#39; then 1 end as r_prefs,</span>
<span class="s1">    case when bucket = &#39;tabs&#39; and method = &#39;GET&#39; then 1 end as r_tabs,</span>
<span class="s1">    case when bucket = &#39;passwords&#39; and method = &#39;GET&#39; then 1 end as r_passwords,</span>
<span class="s1">    case when bucket = &#39;addons&#39; and method = &#39;GET&#39; then 1 end as r_addons,</span>
<span class="s1">    case when bucket = &#39;clients&#39; and method = &#39;POST&#39; then 1 end as w_clients,</span>
<span class="s1">    case when bucket = &#39;crypto&#39; and method = &#39;POST&#39; then 1 end as w_crypto,</span>
<span class="s1">    case when bucket = &#39;forms&#39; and method = &#39;POST&#39; then 1 end as w_forms,</span>
<span class="s1">    case when bucket = &#39;history&#39; and method = &#39;POST&#39; then 1 end as w_history,</span>
<span class="s1">    case when bucket = &#39;keys&#39; and method = &#39;POST&#39; then 1 end as w_keys,</span>
<span class="s1">    case when bucket = &#39;meta&#39; and method = &#39;POST&#39; then 1 end as w_meta,</span>
<span class="s1">    case when bucket = &#39;bookmarks&#39; and method = &#39;POST&#39; then 1 end as w_bookmarks,</span>
<span class="s1">    case when bucket = &#39;prefs&#39; and method = &#39;POST&#39; then 1 end as w_prefs,</span>
<span class="s1">    case when bucket = &#39;tabs&#39; and method = &#39;POST&#39; then 1 end as w_tabs,</span>
<span class="s1">    case when bucket = &#39;passwords&#39; and method = &#39;POST&#39; then 1 end as w_passwords,</span>
<span class="s1">    case when bucket = &#39;addons&#39; and method = &#39;POST&#39; then 1 end as w_addons</span>
<span class="s1">  from sync</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">transformed</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sql_transform</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">transformed</span><span class="o">.</span><span class="n">registerTempTable</span><span class="p">(</span><span class="s2">&quot;tx&quot;</span><span class="p">)</span>

<span class="n">sql_device_activity</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">  select</span>
<span class="s1">    uid,</span>
<span class="s1">    dev,</span>
<span class="s1">    max(ua_os) as ua_os,</span>
<span class="s1">    max(ua_browser) as ua_browser,</span>
<span class="s1">    max(ua_version) as ua_version,</span>
<span class="s1">    min(t) as min_t,</span>
<span class="s1">    max(t) as max_t,</span>
<span class="s1">    sum(posts) as posts,</span>
<span class="s1">    sum(gets) as gets,</span>
<span class="s1">    sum(puts) as puts,</span>
<span class="s1">    sum(dels) as dels,</span>
<span class="s1">    sum(aoks) as aoks,</span>
<span class="s1">    sum(oops) as oops,</span>
<span class="s1">    sum(fups) as fups,</span>
<span class="s1">    sum(r_clients) as r_clients,</span>
<span class="s1">    sum(r_crypto) as r_crypto,</span>
<span class="s1">    sum(r_forms) as r_forms,</span>
<span class="s1">    sum(r_history) as r_history,</span>
<span class="s1">    sum(r_keys) as r_keys,</span>
<span class="s1">    sum(r_meta) as r_meta,</span>
<span class="s1">    sum(r_bookmarks) as r_bookmarks,</span>
<span class="s1">    sum(r_prefs) as r_prefs,</span>
<span class="s1">    sum(r_tabs) as r_tabs,</span>
<span class="s1">    sum(r_passwords) as r_passwords,</span>
<span class="s1">    sum(r_addons) as r_addons,</span>
<span class="s1">    sum(w_clients) as w_clients,</span>
<span class="s1">    sum(w_crypto) as w_crypto,</span>
<span class="s1">    sum(w_forms) as w_forms,</span>
<span class="s1">    sum(w_history) as w_history,</span>
<span class="s1">    sum(w_keys) as w_keys,</span>
<span class="s1">    sum(w_meta) as w_meta,</span>
<span class="s1">    sum(w_bookmarks) as w_bookmarks,</span>
<span class="s1">    sum(w_prefs) as w_prefs,</span>
<span class="s1">    sum(w_tabs) as w_tabs,</span>
<span class="s1">    sum(w_passwords) as w_passwords,</span>
<span class="s1">    sum(w_addons) as w_addons</span>
<span class="s1">  from tx group by uid, dev</span>
<span class="s1">&#39;&#39;&#39;</span>
<span class="n">rolled_up</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sql_device_activity</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1"># Store device activity rollups</span>
<span class="n">sync_log_device_activity_s3base</span> <span class="o">=</span> <span class="s2">&quot;{}/sync_log_device_activity/v1&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_s3_prefix</span><span class="p">)</span>
<span class="n">sync_log_device_activity_s3path</span> <span class="o">=</span> <span class="s2">&quot;{}/day={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sync_log_device_activity_s3base</span><span class="p">,</span> <span class="n">target_day</span><span class="p">)</span>

<span class="c1"># TODO: Do we need to repartition?</span>
<span class="n">rolled_up</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">sync_log_device_activity_s3path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">compute_device_counts</span><span class="p">(</span><span class="n">device_activity</span><span class="p">,</span> <span class="n">target_day</span><span class="p">):</span>
    <span class="n">device_activity</span><span class="o">.</span><span class="n">registerTempTable</span><span class="p">(</span><span class="s2">&quot;device_activity&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span>
    <span class="n">last_week_date</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">target_day</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="n">timedelta</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
    <span class="n">last_week</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">last_week_date</span><span class="p">,</span> <span class="n">df</span><span class="p">)</span>
    <span class="n">sql_device_counts</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        select</span>
<span class="s2">          uid,</span>
<span class="s2">          count(distinct dev) as devs</span>
<span class="s2">        from</span>
<span class="s2">          (select</span>
<span class="s2">            uid,</span>
<span class="s2">            dev</span>
<span class="s2">          from device_activity</span>
<span class="s2">          where uid in</span>
<span class="s2">            (select distinct(uid) from device_activity where day = &#39;{}&#39;)</span>
<span class="s2">            and day &gt; &#39;{}&#39;</span>
<span class="s2">            and day &lt;= &#39;{}&#39;)</span>
<span class="s2">        group by uid</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">target_day</span><span class="p">,</span> <span class="n">last_week</span><span class="p">,</span> <span class="n">target_day</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sql_device_counts</span><span class="p">)</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="c1"># Compute and store device counts</span>

<span class="c1"># Re-read device activity data from S3 so we can look at historic info</span>
<span class="n">device_activity</span> <span class="o">=</span> <span class="n">sqlContext</span><span class="o">.</span><span class="n">read</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">sync_log_device_activity_s3base</span><span class="p">)</span>

<span class="n">device_counts</span> <span class="o">=</span> <span class="n">compute_device_counts</span><span class="p">(</span><span class="n">device_activity</span><span class="p">,</span> <span class="n">target_day</span><span class="p">)</span>

<span class="n">sync_log_device_counts_s3path</span> <span class="o">=</span> <span class="s2">&quot;{}/sync_log_device_counts/v1/day={}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dest_s3_prefix</span><span class="p">,</span> <span class="n">target_day</span><span class="p">)</span>
<span class="n">device_counts</span><span class="o">.</span><span class="n">repartition</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">parquet</span><span class="p">(</span><span class="n">sync_log_device_counts_s3path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;overwrite&quot;</span><span class="p">)</span>
</pre></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
          <div class="col-md-12">
            <h2> 0 Comments </h2>
            </br>
            <div>
              <div class="row">
                <div class="col-md-12">
                  <textarea class="form-control" type="text" id="comment-text" style="height:87px;" placeholder="Leave a comment..."></textarea>
                </div>
              </div>
            </div>
            </br>
            <div>
              <button class="btn btn-primary" id="post_comment_btn">Post Comment</button>
            </div>
          </div>
        </div>

        <br>

        <div class="row">
          <div class="col-md-12">
            
          </div>
          </br>
        </div>
    </div>
  </div>


        </div>

        <div class="footer">
            Served with <span class="glyphicon glyphicon-heart"></span> by <a href="https://github.com/airbnb/knowledge-repo">Knowledge Repo</a> <a  href="https://github.com/airbnb/knowledge-repo/releases/tag/v0.7.4">0.7.4</a><br />
            <i title="Last checked for updates: 4 minutes ago">Last indexed: 14 hours ago</i>
        </div>

        


        <script type='text/javascript'>
            $("#searchbar")[0].setSelectionRange(1000, 1000);

            $('#searchbar').typeahead({
                hint: false,
                highlight: true,
                minLength: 1
              },
              {
                name: 'knowledge_posts',
                limit: 10,
                display: function (item) {
                  return item.title + " - " + item.author;
                },
                templates: {
                  empty: Handlebars.compile(
                    '<div class="tt-not-found">' +
                      'Unable to find any posts that match the current query' +
                      '</div>'
                  ),
                  suggestion: function(data) {
                    return '<p style="overflow-wrap:break-word"><strong class="text-rausch">' + data.title + '</strong> – ' + data.author + '</p>';
                  }
                },
                source: function(q, sync, async) {
                  $.ajax('/ajax/index/typeahead?search=' + q,
                  {
                    success: function(data,status){ async(JSON.parse(data)); }
                  })
                }
              });


            $('#searchbar').bind('typeahead:select', function(obj, datum, name) {
              window.location = '/post/'+encodeURIComponent(datum.path);
            });

            $('#searchbar').keypress(function(event){
              var keycode = (event.keyCode ? event.keyCode : event.which);
              if(keycode == '13'){
                var path = document.location.pathname;
                window.location = '/feed?filters=' + $('#searchbar').val()
              }
            });

            var padding = $('.tt-menu').outerWidth()
            $('.tt-menu').width($('#searchbar').width() + padding + "px")

        </script>
        

<script src="/static/js/tooltips.js" type="text/javascript"></script>
<script type="text/javascript">
$("document").ready(function(){
  var is_webeditor = false;
  
  var post_id = "1";
  var id = "None";
  var post_path = "etl/sync_log.kp"
  var data_repo_github_root = ""
  tooltipsJx.initializeTooltips(is_webeditor, post_id, id, data_repo_github_root);

  $(".btn-rendered").on("click", function(){
    document.location.href = "/post/" + encodeURI(post_path);
  })

  $(".btn-raw").on("click", function(){
    document.location.href = "/post/" + encodeURI(post_path) + "?render=raw";
  })

  $(".btn-webeditor").on("click", function(){
    document.location.href = "/edit/" + encodeURI(post_path);
  })
});

</script>



<script src="/static/js/helpers.js"></script>
<script src="/static/js/tags.js" type="text/javascript"></script>
<script src="/static/js/icons.js" type="text/javascript"></script>
<script src="/static/js/comments.js" type="text/javascript"></script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
      processEscapes: true
    },
    "HTML-CSS": { availableFonts: ["TeX"] }
  });
</script>
<script type="text/javascript"
  src="https://cdn.mathjax.org/mathjax/latest/MathJax.js">
</script>

<script>
$(document).on('ready', function(){
  // Make the Rendered Markdown Button active
  $(".btn-rendered").addClass("btn-active");

  // Initialize headers
  helpersJx.linkifyHeaders();

  // Initialize comments
  var post_path = 'etl/sync_log.kp';

  $("#post_comment_btn").on('click', function(){
      comment_author = 'knowledge_default';
      post_author = 'mreid-moz';
      post_title = 'Bug 1291340 - Import sync log data';
      commentsJx.postComment(comment_author, post_author, post_title, post_path);
      location.reload();
  });

  all_comment_delete_buttons = $("[id^=delete_comment]")
  $.each(all_comment_delete_buttons, function(i,v){
      $(v).on("click", function(){
          var id = v.id;
          var comment_id = id.split("__")[1];
          if(comment_id) {
            commentsJx.deleteComment(post_path, comment_id)
            location.reload();
          }
      });
  });
  $(document.body).on('click',"button[id^=tag-subscription]",function () {
    tagsJx.addTagSubscriptionListener($(this)[0]);
  });
})

//Turn all the headers to be links
//h1 = Title, don't want that
var all_headers = [$("h2"), $("h3"), $("h4"), $("h5"), $("h6")]
$.each(all_headers, function(index, value){
  $.each(value, function(i, v){
    var inner_html = v.innerHTML
    inner_html_no_special = inner_html.replace(/[^a-zA-Z\- ]/g, "")
    var inner_link = "#" + inner_html_no_special.toLowerCase().split(" ").join("-")
    v.innerHTML = "<a href='" + inner_link + "' class=link-reset>" + inner_html + "</a>"
  })
})

//turn all the tags into links, similar to what's done on the feed page
var tags = $("#renderedMarkdown .metadata .tags")[0]
var tags_list = ['sync', 'etl']
var subscriptions_list = []
$.each(tags_list, function(i,tag){
  ahref = document.createElement("a")
  e_tag = encodeURIComponent(tag)
  f_tag = tag.replace("/", "__")
  tag_name = "#" + tag
  tag_subscription_button_id_name = "tag-subscription-" + i + "__" + f_tag
  ahref.setAttribute("data-container", "body")
  ahref.setAttribute("data-toggle", "popover")
  ahref.setAttribute("data-placement", "bottom")
  ahref.setAttribute("data-html", "true")
  ahref.setAttribute("data-tag-name", f_tag)
  if (subscriptions_list.indexOf(tag) >= 0) {
    ahref.setAttribute("class", "label label-subscribed pop")
    ahref.setAttribute("data-content", "<div class='content'>" +
                  " <button class='btn btn-small btn-primary btn-unsubscribe'" +
                        " title='' " +
                          " id='" + tag_subscription_button_id_name + "'> " +
                    " <i class='glyphicon glyphicon-remove-sign glyphicon-white'></i>Unsubscribe " +
                  " </button> " +
                  " </div>")
  } else {
    ahref.setAttribute("class", "label label-unsubscribed pop")
    ahref.setAttribute("data-content", "<div class='content'>" +
                  " <button class='btn btn-small btn-default btn-subscribe'" +
                        " title='' " +
                          " id='" + tag_subscription_button_id_name + "'> " +
                    " <i class='glyphicon glyphicon-ok-sign glyphicon-filled'></i>Subscribe " +
                  " </button> " +
                  " </div>")
  }
  ahref.setAttribute("href", "/tag_pages?tag=" + e_tag)
  ahref.setAttribute("style", "font-weight:normal")
  if (i == 0){
    ahref.innerHTML = " "
    colon = document.createElement("text")
    colon.innerHTML = "<b>Tags</b>: "
    tags.appendChild(colon)
  }
  ahref.innerHTML = ahref.innerHTML + tag_name
  tags.appendChild(ahref)
  if (i != tags_list.length - 1){
    comma = document.createElement("text")
    comma.innerText = ", "
    tags.appendChild(comma)
  }
})
tags.nextSibling.remove()

tags.innerHTML += "<i class='glyphicon glyphicon-edit icon-gray' style='font-size:12pt; padding-left:4px' id='tooltip-edit_tags'></i>"

$(".pop").popover({ trigger: "manual" , html: true, animation:false, delay: 100})
  .on("mouseenter", function () {
      var _this = this;
      $(this).popover("show");
      $(".popover").on("mouseleave", function () {
          $(_this).popover('hide');
      });
  }).on("mouseleave", function () {
      var _this = this;
      setTimeout(function () {
          if (!$(".popover:hover").length) {
              $(_this).popover("hide");
          }
      }, 300);
});

$('#tooltip-edit_tags').click(function(){
  $('#tooltip-edit_tags')[0].setAttribute("style", "display:none")
  previousSibling = $("#tooltip-edit_tags")[0].previousSibling
  tags_string = tags_list.join(", ")
  form = document.createElement("form")
  input = document.createElement("input")
  tags_text = document.createElement("text")
  icon_class = document.createElement("i")
  icon_class.setAttribute("class", "glyphicon glyphicon-upload icon-gray")
  icon_class.setAttribute("style", "font-size:23px; padding-left:4px")
  icon_class.setAttribute("id", "tooltip-save_tags")
  tags_text.innerText = "Tags: "
  input.setAttribute('type', 'text')
  input.setAttribute('name', 'tags_list')
  input.setAttribute('value', tags_string)
  input.setAttribute('style', 'width:75%; display: inline-block')
  input.setAttribute('id' , 'change_tags')
  form.appendChild(tags_text)
  tags.textContent = " "
  form.appendChild(input)
  form.appendChild(icon_class)
  tags.appendChild(form)


  $("#tooltip-save_tags").click(function(){
    tags_string = $("#change_tags")[0].value
    tags_list = tags_string.split(",")

    var re = /^[a-z0-9\-\_\:\/]+$/i
    var good = true
    for (var i = 0; i < tags_list.length; i++){
      tag = tags_list[i]
      if (tag.length == 0){
        alert("There is a tag with length 0 - possible a trailing comma?")
        good = false
        break
      } else {
        tag_name = tag.trim()
        if (!(re.test(tag_name))){
           alert("The tag contains special characters. Make sure there are only alphanumeric characters in your tag")
           good = false
           break
        }
      }
    }
    if (good) {
    var postContent = {}
      postContent['tags'] = tags_string
      $.ajax({
        type: "POST",
        dataType: "json",
        data: JSON.stringify(postContent),
        contentType: "application/json",
        url: '/tag_list?post_path=etl/sync_log.kp',
        async: false
      });
      location.reload()
    }
  })

  tags.nextSibling.remove()

  // Allow user to edit tags
  var edit_icon = iconsJx.createEditTagsIcon();
  $(tags).after(edit_icon);

  $("#tooltip-edit_tags").on("click", function(){
      var edit_tooltip = $("#tooltip-edit_tags");
      edit_tooltip.attr("style", "display:none");

      var tags_string = tags_list.join(", ");
      var form = $("<form>");
      var input = $("<input>");

      var tags_text = $("<text>");
      tags_text.html("Tags: ");


      var icon = iconsJx.createSaveTagsIcon();

      input.attr("type", "text");
      input.attr("name", "tags_list");
      input.attr("style", "width:75%; display: inline-block");
      input.attr("id", "change_tags");

      form.append(tags_text);
      tags.textContent = " ";
      tags_text.innerHTML = "Tags: ";
      form.append(input);
      form.append(icon);
      tags.appendChild(form[0]);
      $("#change_tags")[0].value = tags_string;


      $("#change_tags").keypress(function(e){
          if (e.which == 13){
              var tags_string = $("#change_tags")[0].value;
              var post_path = "etl/sync_log.kp";
              tagsJx.changeAndSaveTags(post_path, tags_string);
              return false;
          };
      });


      $("#tooltip-save_tags").click(function(){
          var tags_string = $("#change_tags")[0].value;
          var post_path = "etl/sync_log.kp";
          tagsJx.changeAndSaveTags(post_path, tags_string);
      });

       $("form").submit(function(){
          var tags_string = $("#change_tags")[0].value;
          var post_path = "etl/sync_log.kp";
          tagsJx.changeAndSaveTags(post_path, tags_string);
          return false
      })
  });

});

</script>


    </body>

</html>